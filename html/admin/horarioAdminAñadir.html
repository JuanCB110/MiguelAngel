<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="../../css/principal.css">
        <link href='https://cdn.jsdelivr.net/npm/boxicons@2.0.5/css/boxicons.min.css' rel='stylesheet'>
        <title>Horario Administrador</title>
        <style>
            .bloque-horario {
                background-color: #f5f5f5;
                border-radius: 10px;
                padding: 15px;
                margin-bottom: 20px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                
            }
            .time-input {
                width: 800%;
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 5px;
                font-size: 16px;
            }
            .hidden {
                display: none;
            }
            .horario-header {
                background-color: #e0e0e0;
                padding: 10px;
                margin-bottom: 15px;
                border-radius: 5px;
                text-align: center;
                font-weight: bold;
            }
            /* Estilos mejorados para selectores */
            select {
                background-color: white;
                color: #333;
                font-size: 16px;
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 5px;
                width: 100%;
                cursor: pointer;
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
                background-repeat: no-repeat;
                background-position: right 10px center;
                background-size: 1em;
            }
            select option {
                color: #333;
                background-color: white;
                padding: 8px;
                font-size: 16px;
            }
            select:focus {
                outline: none;
                border-color: #007bff;
                box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
            }
            /* Estilos para los mensajes de carga */
            .loading-message {
                text-align: center;
                padding: 10px;
                background-color: #f8f9fa;
                border-radius: 5px;
                margin-top: 10px;
                margin-bottom: 10px;
                border: 1px solid #ddd;
            }
        </style>
    </head>
    <body id="body">
        <div class="l-navbar" id="navbar">
            <nav class="nav">
                <div>
                    <a href="#" class="nav__logo">
                        <img src="../../assets/star.svg" alt="" class="nav__logo-icon">
                        <span class="nav__logo-text">Admin</span>
                    </a>
    
                    <div class="nav__toggle" id="nav-toggle">
                        <i class='bx bx-chevron-right'></i>
                    </div>
    
                    <ul class="nav__list">
                        <a href="menuAdmin.html" class="nav__link">
                            <i class='bx bx-grid-alt nav__icon'></i>
                            <span class="nav__text">Menu</span>
                        </a>
                        <a href="#" class="nav__link active">
                            <i class='bx bx-calendar-star nav__icon'></i>
                            <span class="nav__text">Horarios</span>
                        </a>
                        <a href="ChecadorHorario.html" class="nav__link">
                            <i class='bx bx-check-square nav__icon'></i>
                            <span class="nav__text">Asistencias</span>
                        </a>
                        <a href="ReporteAsistencias.html" class="nav__link">
                            <i class='bx bx-bar-chart-alt-2 nav__icon'></i>
                            <span class="nav__text">Reportes</span>
                        </a>
                        <a href="gruposAdmin.html" class="nav__link">
                            <i class='bx bx-buildings nav__icon'></i>
                            <span class="nav__text">Grupos</span>
                        </a>
                        <a href="usuariosAdmin.html" class="nav__link">
                            <i class='bx bx-user nav__icon' ></i>
                            <span class="nav__text">Usuarios</span>
                        </a>
                        <a href="materiasAdmin.html" class="nav__link">
                            <i class='bx bx-book-bookmark nav__icon' ></i>
                            <span class="nav__text">Materia</span>
                        </a>
                        
                        <a href="temariosAdmin.html" class="nav__link">
                            <i class='bx bx-bookmark nav__icon'></i>
                            <span class="nav__text">Temario</span>
                        </a>
                        <a href="asignarJefeGrupo.html" class="nav__link">
                            <i class='bx bx-user-check nav__icon'></i>
                            <span class="nav__text">Jefes de grupo</span>
                        </a>
                        <a href="asignarAlumnoGrupo.html" class="nav__link">
                            <i class='bx bx-user-plus nav__icon'></i>
                            <span class="nav__text">Alumnos</span>
                        </a>
                    </ul>
                </div>
                <a href="../../index.html" class="nav__link" id="logout-link">           
                    <i class='bx bx-log-out-circle nav__icon'></i>
                    <span class="nav__text">Salir</span>
                </a>
            </nav>
        </div>

        <section>
            <div class="barra-opciones" style="width: 40%;">
                <a href="horarioAdmin.html">Ver Grupos</a>
                <a href="horarioVerMaestros.html">Ver Maestros</a>
                <a href="" class="activo">Agregar Grupo</a>
                <a href="horarioAdminAñadirMaestro.html">Agregar Maestro</a>
            </div>

            <form action="" class="form-usuarios" id="horario-form">

                <h1>Seleccione el grupo al que pertenece el horario</h1>
                <select name="grupo" id="grupo-select">
                    <option value="">Seleccione un grupo</option>
                </select>

                <h1>Seleccione el edificio al que pertenece el horario</h1>
                <select name="edificio" id="edificio-select">
                    <option value="">Seleccione un edificio</option>
                </select>

                <h1>Seleccione el aula al que pertenece el horario</h1>
                <select name="aula" id="aula-select">
                    <option value="">Seleccione un aula</option>
                </select>

                <h1>Seleccione la cantidad de clases que tendrá el horario</h1>
                <select name="cantidad-clases" id="cantidad-clases">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                </select>

                <!-- Contenedor para bloques de horario dinámicos -->
                <div id="bloques-container"></div>

                <!-- Template oculto para maestros y materias, será usado dinámicamente -->
                <div id="templates" class="hidden">
                    <div id="maestros-template">
                        <!-- Se llenará con JavaScript -->
                    </div>
                    <div id="materias-template">
                        <!-- Se llenará con JavaScript -->
                    </div>
                </div>

                <button class="boton-global" type="submit">Crear Horario</button>
            </form>
        </section><br>
    </body>

<script src="../../js/sidebar.js"></script>
<script src="../../js/barraOpciones.js"></script>
<script type="module">
    import { crearHorario } from '../../bd/horarios.js';
    import { getGrupos, getEdificios, getAulas } from '../../bd/grupos.js';
    import { getMaestros } from '../../bd/maestros.js';
    import { getMaterias } from '../../bd/materias.js';
    import { checkAdminAuth, logout } from '../../bd/auth.js';
    
    // Verificar autenticación
    checkAdminAuth();
    
    // Cache para maestros y materias
    let maestrosCache = [];
    let materiasCache = [];
    
    // Cargar datos iniciales
    async function cargarDatos() {
        try {
            // Mostrar mensaje de carga
            document.getElementById('bloques-container').innerHTML = '<div class="loading-message">Cargando datos, por favor espere...</div>';
            
            // Cargar grupos
            const grupos = await getGrupos();
            const selectGrupo = document.getElementById('grupo-select');
            selectGrupo.innerHTML = '<option value="">Seleccione un grupo</option>';
            grupos.forEach(grupo => {
                const option = document.createElement('option');
                option.value = grupo.id;
                option.textContent = grupo.numeroGrupo || grupo.nombre;
                selectGrupo.appendChild(option);
            });
            console.log("Grupos cargados:", grupos.length);
            
            // Cargar edificios
            const edificios = await getEdificios();
            const selectEdificio = document.getElementById('edificio-select');
            selectEdificio.innerHTML = '<option value="">Seleccione un edificio</option>';
            edificios.forEach(edificio => {
                const option = document.createElement('option');
                option.value = edificio.id;
                option.textContent = edificio.nombre;
                selectEdificio.appendChild(option);
            });
            console.log("Edificios cargados:", edificios.length);

            // Cargar aulas
            const aulas = await getAulas();
            const selectAula = document.getElementById('aula-select');
            selectAula.innerHTML = '<option value="">Seleccione un aula</option>';
            aulas.forEach(aula => {
                const option = document.createElement('option');
                option.value = aula.id;
                option.textContent = aula.nombre;
                selectAula.appendChild(option);
            });
            console.log("Aulas cargadas:", aulas.length);
            
            // Cargar maestros
            maestrosCache = await getMaestros();
            console.log("Maestros cargados:", maestrosCache.length, maestrosCache);
            
            if (maestrosCache.length === 0) {
                console.error("No se encontraron maestros en la base de datos");
                alert("No se encontraron maestros. Por favor, agregue maestros primero.");
            }
            
            const maestrosTemplate = document.getElementById('maestros-template');
            maestrosTemplate.innerHTML = ''; // Limpiar antes de agregar
            
            // Opción por defecto
            const defaultMaestroOption = document.createElement('option');
            defaultMaestroOption.value = "";
            defaultMaestroOption.textContent = "Seleccione un maestro";
            maestrosTemplate.appendChild(defaultMaestroOption);
            
            // Agregar cada maestro
            maestrosCache.forEach(maestro => {
                const option = document.createElement('option');
                option.value = maestro.id;
                option.textContent = maestro.nombre || maestro.name || `Maestro ${maestro.id}`;
                console.log("Añadiendo maestro:", option.value, option.textContent, maestro);
                maestrosTemplate.appendChild(option);
            });
            
            // Cargar materias
            materiasCache = await getMaterias();
            console.log("Materias cargadas:", materiasCache.length);
            
            if (materiasCache.length === 0) {
                console.error("No se encontraron materias en la base de datos");
                alert("No se encontraron materias. Por favor, agregue materias primero.");
            }
            
            const materiasTemplate = document.getElementById('materias-template');
            materiasTemplate.innerHTML = ''; // Limpiar antes de agregar
            
            // Opción por defecto
            const defaultMateriaOption = document.createElement('option');
            defaultMateriaOption.value = "";
            defaultMateriaOption.textContent = "Seleccione una materia";
            materiasTemplate.appendChild(defaultMateriaOption);
            
            // Agregar cada materia
            materiasCache.forEach(materia => {
                const option = document.createElement('option');
                option.value = materia.id;
                option.textContent = materia.nombre; //|| `Materia ${materia.id}`;
                materiasTemplate.appendChild(option);
            });
            
            // Inicializar el primer bloque de clase
            manejarCambioClases({ target: { value: 1 } });
            
        } catch (error) {
            console.error('Error al cargar datos:', error);
            alert('Error al cargar datos iniciales: ' + error.message);
        }
    }
    
    // Manejar cambio en cantidad de clases
    function manejarCambioClases(e) {
        const cantidad = parseInt(e.target.value);
        const container = document.getElementById('bloques-container');
        
        // Limpiar contenedor
        container.innerHTML = '';
        
        // Obtener el HTML de los templates
        const maestrosHTML = document.getElementById('maestros-template').innerHTML;
        const materiasHTML = document.getElementById('materias-template').innerHTML;
        
        if (!maestrosHTML || !materiasHTML) {
            console.error("No se pudo obtener el contenido de los templates", { 
                maestrosHTML: maestrosHTML?.length || 0, 
                materiasHTML: materiasHTML?.length || 0 
            });
            alert("Error al generar los campos de maestros y materias. Intente recargar la página.");
            return;
        }
        
        // Crear nuevos bloques
        for (let i = 0; i < cantidad; i++) {
            const div = document.createElement('div');
            div.className = 'bloque-horario';
            
            // Crear un número de clase para cada bloque
            const bloqueNum = i + 1;
            
            div.innerHTML = `
                <div class="horario-header">Clase ${bloqueNum}</div>
                <div class="busqueda">
                    <label for="hora-inicio-${i}">Hora de inicio:</label>
                    <input type="time" id="hora-inicio-${i}" class="time-input" required>
                    <h1>A</h1>
                    <label for="hora-fin-${i}">Hora de fin:</label>
                    <input type="time" id="hora-fin-${i}" class="time-input" required>
                </div>   
                <h1>Seleccione el maestro para esta clase</h1>
                <select name="maestro-${i}" id="maestro-${i}" required>
                    ${maestrosHTML}
                </select>
                <h1>Seleccione la materia que se impartirá</h1>
                <select name="materia-${i}" id="materia-${i}" required>
                    ${materiasHTML}
                </select>
            `;
            container.appendChild(div);
            
            // Verificar que los selectores estén funcionando correctamente
            const maestroSelect = div.querySelector(`#maestro-${i}`);
            const materiaSelect = div.querySelector(`#materia-${i}`);
            
            if (maestroSelect.options.length <= 1) {
                console.error(`Pocas o ninguna opción en el selector de maestros para clase ${bloqueNum}`, maestroSelect.innerHTML);
            }
            
            if (materiaSelect.options.length <= 1) {
                console.error(`Pocas o ninguna opción en el selector de materias para clase ${bloqueNum}`, materiaSelect.innerHTML);
            }
        }
    }
    
    // Eventos
    document.addEventListener('DOMContentLoaded', () => {
        cargarDatos();
        
        // Evento para cambio en cantidad de clases
        const selectCantidad = document.getElementById('cantidad-clases');
        selectCantidad.addEventListener('change', manejarCambioClases);
        
        // Evento para cierre de sesión
        document.getElementById('logout-link').addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                await logout();
                window.location.href = '../../index.html';
            } catch (error) {
                console.error('Error al cerrar sesión:', error);
            }
        });
        
        // Formulario
        const form = document.getElementById('horario-form');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const grupoId = document.getElementById('grupo-select').value;
            const edificioId = document.getElementById('edificio-select').value;
            const aulaId = document.getElementById('aula-select').value;
            
            // Validar que se hayan seleccionado valores
            if (!grupoId || !edificioId || !aulaId) {
                alert('Por favor seleccione grupo, edificio y aula');
                return;
            }
            
            // Obtener los nombres para almacenarlos también
            const edificioNombre = document.getElementById('edificio-select').options[document.getElementById('edificio-select').selectedIndex].textContent;
            const aulaNombre = document.getElementById('aula-select').options[document.getElementById('aula-select').selectedIndex].textContent;
            const grupoNombre = document.getElementById('grupo-select').options[document.getElementById('grupo-select').selectedIndex].textContent;
            
            const bloques = document.querySelectorAll('.bloque-horario');
            const horarios = [];
            
            // Validar y procesar cada bloque
            for (let i = 0; i < bloques.length; i++) {
                const bloque = bloques[i];
                const horaInicio = bloque.querySelector(`#hora-inicio-${i}`).value;
                const horaFin = bloque.querySelector(`#hora-fin-${i}`).value;
                const maestroSelect = bloque.querySelector(`#maestro-${i}`);
                const materiaSelect = bloque.querySelector(`#materia-${i}`);
                
                if (!horaInicio || !horaFin || !maestroSelect.value || !materiaSelect.value) {
                    alert(`Por favor complete todos los campos en la Clase ${i+1}`);
                    return;
                }
                
                const maestroNombre = maestroSelect.options[maestroSelect.selectedIndex].textContent;
                const materiaNombre = materiaSelect.options[materiaSelect.selectedIndex].textContent;
                
                horarios.push({
                    grupoId,
                    grupo: grupoNombre,
                    edificioId,
                    edificio: edificioNombre,
                    aulaId,
                    aula: aulaNombre,
                    horaInicio,
                    horaFin,
                    maestroId: maestroSelect.value,
                    nombreMaestro: maestroNombre,
                    materiaId: materiaSelect.value,
                    materia: materiaNombre,
                    createdAt: new Date()
                });
            }
            
            // Validar que no haya conflictos de horario
            for (let i = 0; i < horarios.length; i++) {
                for (let j = i + 1; j < horarios.length; j++) {
                    if (
                        (horarios[i].horaInicio <= horarios[j].horaInicio && horarios[i].horaFin > horarios[j].horaInicio) ||
                        (horarios[j].horaInicio <= horarios[i].horaInicio && horarios[j].horaFin > horarios[i].horaInicio)
                    ) {
                        alert(`Hay un conflicto de horario entre las clases ${i+1} y ${j+1}`);
                        return;
                    }
                }
            }
            
            try {
                // Mostrar mensaje de procesamiento
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Creando horario...';
                submitBtn.disabled = true;
                
                // Crear cada horario
                for (const horario of horarios) {
                    await crearHorario(horario);
                }
                
                alert('Horario creado correctamente');
                window.location.href = 'horarioAdmin.html';
            } catch (error) {
                console.error('Error al crear horario:', error);
                alert('Error al crear horario: ' + error.message);
                
                // Restaurar botón
                const submitBtn = form.querySelector('button[type="submit"]');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });
    });
</script>
</html>